<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="static/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh">

    <title>Adora Belle - Request Scheduling System</title>
  </head>
  <body>
	<style>
	  /*!
	   * Font Awesome Free 5.13.0 by @fontawesome - https://fontawesome.com
	   * License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
	   */
	  @font-face {
		  font-family: fontawesome-solid;
		  src: url(static/fa-solid-900.woff);
	  }
	</style>
	
	<nav class="navbar sticky-top navbar-dark bg-dark d-flex justify-content-between">
	  <span>
		<a class="navbar-brand" href="#">Adora Belle</a>
		<div class="navbar-text">- Your hands where I can see them</div>
	  </span>
	  <span id="navbarbuttonarea">
	  </span>
	</nav>

	<div class="col text-center">
	  <br />

	  <h1 id="lectureName"></h1>

	  <div>
		Available Timeslots:
		<ul id="timeSlots" class="list-group" style="list-style: none">
		</ul>
	  </div>
		


	  <br />

	  <button id="questionBtn"   type="button" class="btn btn-primary btn-lg">Ask a Question</button>
	  <button id="submissionBtn" type="button" class="btn btn-secondary btn-lg">Make a submission</button><br/><br/>

	  <div id="errPanel" class="mx-auto w-75"></div>
	  <h2>Currently Serviced Requests</h2>
	  <div id="servicedReqs" class="list-group mx-auto w-75" style="display:inline-block">
	  </div>

	  <br/>
	  <br/>

	  <h2>Pending Requests</h2>
	  <div id="pendingReqs" class="list-group mx-auto w-75" style="display:inline-block">
	  </div>

	  <div id="backlogheader" style="display: none">
		<br/>
		<br/>

		<h2>Administrative Action Log</h2>
		<ul id="backlogitems" class="list-group-flush"></div>
	  </div>
	</div>


	<!-- Login modal interface, hidden by default -->
	<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="loginModalLabel">Login</h5>
		  </div>
		  <form id="loginform">
			<div class="modal-body">
			  <div class="form-group">
				<label for="usernameInput">Username</label>
				<input type="text" class="form-control" id="usernameInput" placeholder="Enter username">
			  </div>
			  <div class="form-group">
				<label for="passwordInput">Password</label>
				<input type="password" class="form-control" id="passwordInput" placeholder="Password">
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="submit" class="btn btn-primary">Submit</button>
			</div>
		  </form>
		</div>
	  </div>
	</div>

	<footer class="footer">
	  <div class="container">
		<span class="text-muted">Adora-Belle is <a href="https://www.fsf.org/about/what-is-free-software" target="_blank">Free-Software</a> and <a href="https://github.com/noctux/adora-belle" target="_blank">available</a> under the Terms and Conditions of the <a href="https://www.gnu.org/licenses/agpl-3.0.en.html" target="_blank">AGPL3 License</a>.</span>
	  </div>
	</footer>

	<style>
	  html {
		  position: relative;
		  min-height: 100%;
	  }
	  body {
		  margin-bottom: 60px; /* Margin bottom by footer height */
	  }
	  .footer {
		  position: absolute;
		  bottom: 0;
		  width: 100%;
		  height: 60px; /* Set the fixed height of the footer here */
		  line-height: 60px; /* Vertically center the text there */
		  background-color: #f5f5f5;
	  }
	</style>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="static/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="></script>
    <script src="static/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"></script>
    <script src="static/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"></script>


	<script>
	  // Initialised with defaults
	  var preferences = {
		  usesound: false,
	  };
	  function loadPreferences() {
		  if (typeof(Storage) !== "undefined") {
			  var stored = localStorage.getItem("preferences");
			  if (stored !== "undefined") {
				  try {
					  preferences = JSON.parse(stored);
					  console.log("parsed preferences");
					  console.log(preferences);
				  } catch(e) {
					  console.log("Error parsing preferences from localstorage, skipping. Input was: " + stored);
				  }
			  } else {
				  console.log("No stored preferences found, keeping defaults");
			  }
		  } else {
			  console.log("Browser does not support local storage, no persistent storage available");
		  }
	  }
	  loadPreferences();

	  function storePreferences() {
		  if (typeof(Storage) !== "undefined") {
			  localStorage.setItem("preferences", JSON.stringify(preferences));
			  console.log("Stored preferences to local storage");
		  } else {
			  console.log("Browser does not support local storage, no persistent storage available");
		  }
	  }

	  function getPreference(id) {
		  return preferences[id];
	  }

	  function setPreference(id, newValue) {
		  preferences[id] = newValue;
		  storePreferences();
	  }

	  function isLocalhost() {
		  const LOCAL_DOMAINS = ["localhost", "127.0.0.1", "[::1]"];

		  return LOCAL_DOMAINS.includes(window.location.hostname);
	  }

	  function testBasicCredentials(endpoint, username, password) {
		  var success = false;

		  var cfg = {
			  type: "GET",
			  url: endpoint,
			  beforeSend: function (xhr) {
				  xhr.setRequestHeader ("Authorization", "Basic " + btoa(username + ":" + password));
			  },
			  dataType: 'json',
			  async: false,
			  success: function (){success = true;},
			  error: function(){ success = false; alert("Authentication failed: wrong username or password"); }
		  };
		  if (!isLocalhost()) {
			  cfg["username"] = username;
			  cfg["password"] = password;
		  }
		  $.ajax(cfg);
		  return success;
	  }

	  function showError(msg) {
		  var elem = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"></div>').text(msg);
		  elem.append('<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>');
		  $('#errPanel').append(elem);
	  }

	  function registerReloadButton() {
		  var elem = $('<button id="configreloadBtn" class="btn btn-sm btn-outline-primary my-2 my-sm-0" type="submit">Reload Config</button>');
		  $('#navbarbuttonarea').append(elem);
	  }

	  var username;
	  var password;
	  var informationendpoint = "public/requests";
	  var conferencebaseurl;
	  var admininterface = false;
	  if (window.location.pathname.split('/').pop() == "admin.html") {
		  informationendpoint = "admin/requests";
		  admininterface = true;
		  registerReloadButton();
	  }

	  function triggerConfigReload() {
		  $.ajax({
			  type: "POST",
			  contentType: "application/json; charset=utf-8",
			  url: "admin/reload", 
			  dataType: 'json',
			  data: ""
		  }).done(function (data) {
			  updateUi();
		  }).fail(function (err) {
			  showError(err.responseText);
		  });
	  }

	  function requestHelp(type) {
		  $.ajax({
			  type: "POST",
			  contentType: "application/json; charset=utf-8",
			  url: "public/request", 
			  dataType: 'json',
			  data: JSON.stringify(type)
		  }).done(function (data) {
			  updateUi();
		  }).fail(function (err) {
			  showError(err.responseText);
		  });
	  }

	  function cancelRequest(id) {
		  var payload = {
			  tag: "RequestID",
			  contents: id
		  };
		  $.ajax({
			  type: "POST",
			  contentType: "application/json; charset=utf-8",
			  url: "public/cancel", 
			  dataType: 'json',
			  data: JSON.stringify(payload)
		  }).done(function (data) {
			  updateUi();
		  }).fail(function (err) {
			  showError(err.responseText);
		  });
	  }
	  
	  function adminaction(id, verb) {
		  var payload = [{
			  tag: "RequestID",
			  contents: id
		  }, verb]
		  $.ajax({
			  type: "POST",
			  contentType: "application/json; charset=utf-8",
			  url: "admin/handle", 
			  dataType: 'json',
			  data: JSON.stringify(payload)
		  }).done(function (data) {
			  updateUi();
		  }).fail(function (err) {
			  showError(err.responseText);
		  });
	  }

	  function formatUrl(urlsuffix) {
		  // Some jitsiinstances do not like none alphanumeric characters
		  urlsuffix = urlsuffix.replace(/[^0-9a-z]/gi, '');
		  return conferencebaseurl + "/" + encodeURIComponent(urlsuffix);
	  }

	  function formatTime(time) {
		  var ts   = new Date(time);
		  var now  = new Date();
		  var diff = (now.getTime() - ts.getTime()) / 1000; // Seconds
		  if (diff > 60) {
			  return (diff / 60).toFixed(0) + "min";
		  } else {
			  return diff.toFixed(0) + "s";
		  }
	  }

	  function formatRequest(req, context=null) {
		  var elem;

		  if (context == "dummy") {
			  elem = $('<div class="list-group-item list-group-item-light"></div>');
			  elem.text("Inactive");
		  } else if (req.reqid.tag == "BlindedID" || req.userid.tag == "Anonymous") {
			  elem = $('<div class="list-group-item list-group-item-light"></div>');
			  elem.text(req.reqtype);
		  } else {
			  var url = formatUrl(req.reqid.contents);
			  if (context == "log") {
				  elem = $('<div class="list-group-item list-group-item-secondary align-items-center text-left d-flex flex-wrap justify-content-between"></div>');
			  } else {
				  elem = $('<div class="list-group-item list-group-item-primary align-items-center text-left d-flex flex-wrap justify-content-between"></div>');
				  elem.prop('id', req.reqid.contents);
			  }
			  var typedate = $('<div style="text-align: center"></div>');
			  typedate.text(req.reqtype);
			  if (admininterface) {
				  if (context == "log") {
					  typedate.append(" ");
				  } else {
					  typedate.append('<br/>');
				  }
				  typedate.append(formatTime(req.time) + " ago");
				  elem.append(typedate);
			  }
			  elem.append(typedate);
			  if (admininterface) {
				  var userid = $('<div></div>');
				  userid.text(req.userid.contents);
				  elem.append(userid);
			  }
			  var a = $('<a target="_blank" rel="noopener noreferrer" />');
			  a.attr("href", url);
			  a.text(url);
			  elem.append(a);
			  var actions;
			  var template = $('<button type="button" class="btn btn-secondary btn-sm" />');
			  if (admininterface) {
				  actions = $('<div class="btn-group" role="group" aria-label="actions" />');
				  if (context == "active") {
					  var defer    = template.clone().text("Defer").on('click', function () { adminaction(req.reqid.contents, "Defer") });
					  var complete = template.clone().text("Complete").on('click', function () { adminaction(req.reqid.contents, "Complete") });
					  actions.append(defer);
					  actions.append(complete);
				  } else if (context == "pending") {
					  var handle = template.clone().text("Handle").on('click', function () { adminaction(req.reqid.contents, "Handle") });
					  var discard = template.clone().text("Discard").on('click', function () { adminaction(req.reqid.contents, "Discard") });
					  actions.append(handle);
					  actions.append(discard);
				  }
			  } else {
				  actions = template.text("Cancel");
				  actions.on('click', function () { cancelRequest(req.reqid.contents) })
			  }
			  elem.append(actions);
		  }
		  return elem;
	  }

	  function formatBacklogItem(item) {
		  var log = $('<li class="list-group-item" style="text-align: left" />');
		  log.append(item.actor + ": " + item.action.contents + " (" +  formatTime(item.timeStamp) + " ago)");
		  var reqs = $('<ul class"list-group" />')
		  item.requests.map(x => reqs.append(formatRequest(x, "log")));
		  log.append(reqs);
		  return log;
	  }

	  var seenAdmins = [];

	  function updateServicedRequests(servicedRequests) {
		  var dict = new Object();
		  servicedRequests.forEach(function (item, index) {
			  dict[item[0]] = item[1];
		  });

		  var order;
		  if (admininterface) {
			  Object.keys(dict).forEach(function (elem) {
				  if(!seenAdmins.includes(elem)) {
					  seenAdmins.push(elem);
				  }
			  });
			  order = seenAdmins;
		  } else {
			  order = Object.keys(dict).sort();
		  }

		  var elem = $('#servicedReqs').clone().empty();
		  order.forEach(function (key) {
			  var lbl = $('<label class="d-flex justify-content-start col-form-label-lg"/>');
			  lbl.text(key);
			  elem.append(lbl);
			  if (key in dict) {
				  elem.append(formatRequest(dict[key], "active"));
			  } else {
				  elem.append(formatRequest(undefined, "dummy"));
			  }
		  });
		  $('#servicedReqs').replaceWith(elem);
	  }

	  function updatePendingRequests(pendingRequests) {
		  var elem = $('#pendingReqs').clone().empty();
		  pendingRequests.map(x => elem.append(formatRequest(x, "pending")));
		  $('#pendingReqs').replaceWith(elem);
	  }

	  function updateAdministrativeLog(logItems) {
		  var elem = $('#backlogitems').clone().empty();
		  logItems.map(x => elem.append(formatBacklogItem(x)));
		  $('#backlogitems').replaceWith(elem);
	  }

	  function markRecentlyDeferred(logItems) {
		  var now  = new Date();
		  for (var i = 0; i < logItems.length; i++) {
			  var ts   = new Date(logItems[i].timeStamp);
			  var diff = (now.getTime() - ts.getTime()) / 1000; // Seconds
			  if (diff > 60){
				  break;
			  }
			  if (logItems[i].action.contents !== "Defer") {
				  continue;
			  }
			  logItems[i].requests.forEach(function (req){
				  $('#' + req.reqid.contents)
					  .removeClass('list-group-item-primary list-group-item-secondary')
					  .addClass('list-group-item-warning');
			  });
		  }
	  }

	  function isActive(day, start, end) {
		  var now = new Date;
		  if (day !== ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"][now.getDay()])
		    return false;
		  var h = now.getHours();
		  var m = now.getMinutes();
		  if (h < start[0] || (h == start[0] && m < start[1]))
		    return false;
		  if (h > end[0] || (h == end[0] && m > end[1]))
		    return false;
		  return true;
	  }

	  function formatTimeSlot(ts) {
		  var elem = $('<li/>');
		  var day = ts.day.charAt(0).toUpperCase() + ts.day.slice(1);
		  var start = ts.start.split(':').slice(0,2)
		  var end   = ts.end.split(':').slice(0,2)
		  elem.text(day + ": " + start.join(':') + " - " + end.join(':'));
		  if (isActive(ts.day, start, end)) {
		    elem[0].style.fontWeight = 900;
		  }
		  return elem;
	  }

	  function updateTimeSlots(timeslots) {
		  var elem;
		  if (timeslots.length <= 0) {
			elem = $('<div id="timeSlots" class="list-group" >Timeslots appear to be unrestricted</div>');
		  } else {
			elem = $('<ul id="timeSlots" class="list-group" style="list-style: none"></div>');
			timeslots.map(x => elem.append(formatTimeSlot(x)));
		  }
		  $('#timeSlots').replaceWith(elem);
	  }

	  function updateLectureName(lectureName) {
		  $('#lectureName').text(lectureName);
	  }

	  function updateUi() {
		  $.get(informationendpoint, {
			  dataType: 'json',
		  }).done(function (data) {
			  conferencebaseurl = data.conferenceUrl;
			  updateLectureName(data.lectureName);
			  updateTimeSlots(data.timeSlots);
			  updatePendingRequests(data.pendingRequests);
			  updateServicedRequests(data.activeRequests);
			  if (admininterface) {
				markRecentlyDeferred(data.actionLog);
				updateAdministrativeLog(data.actionLog);
			  }
		  });
	  }

	  function relayoutWidth(window) {
		  var wclass;
		  if (window.width() < 1200) {
			  wclass = "w-100";
		  } else if (window.width() < 1800) {
			  wclass = "w-75";
		  } else {
			  wclass = "w-50";
		  }

		  ['#errPanel', '#servicedReqs', '#pendingReqs'].forEach(function (elem) {
			  var domitem = $(elem);
			  ['w-100', 'w-75', 'w-50'].forEach(c => domitem.removeClass(c));
			  domitem.addClass(wclass);
		  });
	  }

	  function initApi(user, pw) {
		  username = user;
		  password = pw;

		  var cfg = {
			  beforeSend: function (xhr) {
				  xhr.setRequestHeader ("Authorization", "Basic " + btoa(username + ":" + password));
			  },
			  cache: false,
		  };
		  if (!isLocalhost()) {
			  cfg["username"] = username;
			  cfg["password"] = password;
		  }
		  $.ajaxSetup(cfg);

		  if (!admininterface) {
			  $.ajax
			  ({
				  type: "GET",
				  url: "admin/requests",
				  dataType: 'json',
				  async: false,
				  success: function () {
					  alert("Admins should use the admin endpoint (/admin.html), redirecting...");
					  window.location.href = "admin.html";
				  },
				  error: function(){}
			  });
		  }

		  $(window).on('resize', function() {
			  relayoutWidth($(this));
		  });
		  relayoutWidth($(window));

		  updateUi();

		  if (admininterface) {
			$('#questionBtn').detach();
			$('#submissionBtn').detach();
			$('#configreloadBtn').on("click", function (e) { triggerConfigReload() });
			$('#backlogheader').css("display", "initial");
		  } else {
			$('#questionBtn').on("click",     function (e) { requestHelp("Question")   });
			$('#submissionBtn').on("click",   function (e) { requestHelp("Submission") });
		  }

		  window.setInterval(updateUi, 2000);
	  }

	  $('#loginform').on('submit', function(event) {
		  event.preventDefault();
		  var user = $('#usernameInput').val();
		  var pw   = $('#passwordInput').val();
		  if (testBasicCredentials(informationendpoint, user, pw)) {
			  initApi(user, pw);
			  $('#loginModal').modal('hide');
		  } else {
			  $('#usernameInput').val('');
			  $('#passwordInput').val('');
		  }
	  })
	  $('#loginModal').modal({ show: false});
	  $('#loginModal').modal('show');
	</script>

  </body>
</html>
